<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <title>Chef RFCs</title>
    <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link href="/images/favicon.png" rel="icon" type="image/png">
    <link href="/images/favicon.ico" rel="shortcut icon">
  </head>
  <body>
    <div class="container">
      <header class="clearfix">
        <div class="left">
          <a href="http://chef.github.io"><h1>Chef <span>Github</span></h1></a>
        </div>
      </header>
<h1>Chef Authentication Signing Protocol v1.3</h1>

<p>The current Chef signing protocols force users to use SHA1 based algorithms. This RFC proposes a new signing protocol which uses methods approved in <a href="http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-131Ar1.pdf">NIST.SP.800</a> for digital signatures.</p>

<h2>Background</h2>

<p>The Chef Server currently supports 3 different signing protocols: v1.0, v1.1, and v1.2. All of these protocols use a RSA private key to sign a message, which is verified by the server using the public key. Once a signature is created and Base64 encoded, it is broken up into lines of no more than 60 characters and placed into the <code>X-Ops-Authorization-1</code>, <code>X-Ops-Authorization-2</code>, ..., <code>X-Ops-Authorization-N</code> headers.</p>

<h3>Signing Protocol v1.0</h3>

<p>Signing protocol v1.0 signs the following message:</p>
<div class="highlight"><pre><span class="n">Method</span><span class="o">:</span><span class="n">HTTP_METHOD</span>
<span class="n">Hashed</span> <span class="n">Path</span><span class="o">:</span><span class="n">HASHED_PATH</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Content</span><span class="o">-</span><span class="n">Hash</span><span class="o">:</span><span class="n">HASHED_BODY</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Timestamp</span><span class="o">:</span><span class="n">TIME</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">UserId</span><span class="o">:</span><span class="n">USERID</span>
</pre></div>
<p>where:
  - <code>HTTP_METHOD</code> is the method used in the API request
  - <code>HASHED_PATH</code> is the path of the request: <code>/organizations/NAME/name_of_endpoint</code>. The <code>HASHED_PATH</code> must be hashed using SHA1 and encoded using Base64, must not have repeated forward slashes (<code>/</code>), must not end in a forward slash (unless the path is <code>/</code>), and must not include a query string.
  - <code>HASHED_BODY</code> is the Base64 encoded value of the SHA1 hash of the request body
  - <code>TIME</code> is the timestamp in ISO-8601 format and with UTC indicated by a trailing <code>Z</code> and separated by the character <code>T</code>. For example: <code>2013-03-10T14:14:44Z</code>.
  - <code>USERID</code> is the user id, for example the client name</p>

<p>This message is encrypted with the users(or nodes) RSA private key. The server verifies the message by recreating the message using the provided headers and decrypting it using the users public key.</p>

<p>v1.0 is the default version used by Chef Client as of version 12.5.1. However, v1.0 fails when the client name is longer that ~90 characters, so chef client will switch to the v1.1 protocol.</p>

<h3>Signing Protocol v1.1</h3>

<p>Signing protocol v1.1 was introduced to support longer client names. It is almost identical to v1.0, except <code>USERID</code> is now a SHA1 hash of the user id.</p>

<h3>Signing Protocol v1.2</h3>

<p>Signing protocol v1.2 signs the same message as v1.1. The signing, however, is slightly different. The motivation behind v1.2 was to use a standardized signing scheme. v1.2 uses the <code>RSASSA-PKCS1-v1_5</code> signature scheme to sign the message. The hashing algorithm used by the scheme is SHA1. More information about the <code>RSASSA-PKCS1-v1_5</code> can be found in the <a href="https://www.emc.com/collateral/white-papers/h11300-pkcs-1v2-2-rsa-cryptography-standard-wp.pdf">PKCS#1 v2.2 RSA Cryptography Standard</a> document.</p>

<h2>Motivation</h2>

<p>The current signing algorithms used for authentication with the Chef Server are not covered under those which are approved by the NIST.SP.800 guidelines. Chef users working with the U.S. government are often required to ensure their infrastructure meets certain security requirements, including those for cryptographic algorithms as specified in <a href="http://csrc.nist.gov/publications/fips/fips140-2/fips1402.pdf">FIPS 140-2</a>. The SHA-1 algorithm currently used for authentication with the Chef Server is not approved for use in digital signature generation per <a href="http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-131Ar1.pdf">NIST SP 800-131A</a>, thus preventing those users from using Chef in their environments.</p>

<p>The current signing algorithms are also vulnerable to replay attacks by changing the <code>X-Ops-Server-API-Version</code>. Since this header is not covered under the authenticated message, the request could be replayed with a different version, changing the effect the request has.</p>

<h2>Specification</h2>

<h3>v1.3 Message Format</h3>

<p>Following is the message to be signed by the v1.3 protocol.</p>
<div class="highlight"><pre><span class="n">Method</span><span class="o">:</span><span class="n">HTTP_METHOD</span>
<span class="n">Path</span><span class="o">:</span><span class="n">PATH</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Content</span><span class="o">-</span><span class="n">Hash</span><span class="o">:</span><span class="n">HASHED_BODY</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Sign</span><span class="o">:</span><span class="n">version</span><span class="o">=</span><span class="mf">1.3</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Timestamp</span><span class="o">:</span><span class="n">TIME</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">UserId</span><span class="o">:</span><span class="n">USERID</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Server</span><span class="o">-</span><span class="n">API</span><span class="o">-</span><span class="n">Version</span><span class="o">:</span><span class="n">HEADER_X_OPS_SERVER_API_VERSION</span>
</pre></div>
<p>where:
  - <code>PROTOCOL_VERSION</code> is the signing protocol that will be used.
  - <code>HTTP_METHOD</code> is the method used in the HTTP request. It should be all upper case (<code>POST</code>, <code>GET</code>, <code>PUT</code>, etc)
  - <code>PATH</code> us a canonicalized representation of the path. This path must not have repeated forward slashes (<code>/</code>), must not end in a forward slash (unless the path is <code>/</code>), and must not include a query string.
  - <code>HASHED_BODY</code> is the Base64 encoded value of <code>Hash(SHA256, Body)</code>
  - <code>TIME</code> is the timestamp in ISO-8601 format and with UTC indicated by a trailing <code>Z</code> and separated by the character <code>T</code>. For example: <code>2013-03-10T14:14:44Z</code>.
  - <code>USERID</code> is the user id, for example the client name
  - <code>HEADER_X_OPS_SERVER_API_VERSION</code> is the value of <code>X-Ops-Server-API-Version</code> passed to the Chef server.</p>

<p>There is a new line character(<code>\n</code>) after each line in this message <strong>except the last line</strong>.</p>

<h3>v1.3 Signing Protocol</h3>

<p>Signing protocol v1.3 signs message format v1.3 messages using the <code>RSASSA-PKCS1-v1_5</code> signature scheme as described in <a href="https://www.emc.com/collateral/white-papers/h11300-pkcs-1v2-2-rsa-cryptography-standard-wp.pdf">PKCS#1 v2.2 RSA Cryptography Standard</a>. v1.3 will use SHA256 as the hashing algorithm.</p>

<p>This protocol is very similar to v1.2. The signing scheme is the same (RSASSA-PKCS1-v1_5). The message format signs a few additional pieces of information: The signing protocol version, the hashing algorithm to be used, and the <code>X-Ops-Server-API-Version</code> header.</p>

<h3>Example</h3>

<p>The following is an example of how to go from the information required to make a signature to the actual signature. First, an RSA key (private_key.pem):</p>
<div class="highlight"><pre><span class="o">-----</span><span class="vg">BEGIN</span><span class="w"> </span><span class="vg">RSA</span><span class="w"> </span><span class="vg">PRIVATE</span><span class="w"> </span><span class="kr">KEY</span><span class="o">-----</span>
<span class="vg">MIIEpAIBAAKCAQEA0ueqo76MXuP6XqZBILFziH</span><span class="o">/</span><span class="il">9</span><span class="vg">AI7C6PaN5W0dSvkr9yInyGHS</span>
<span class="vg">z</span><span class="o">/</span><span class="vg">IR1</span><span class="o">+</span><span class="il">4</span><span class="vg">tqvP2qlfKVKI4CP6BFH251Ft9qMUBuAsnlAVQ1z0exDtIFFOyQCdR7iXm</span>
<span class="vg">jBIWMSS4buBwRQXwDK7id1OxtU23qVJv</span><span class="o">+</span><span class="vg">xwEV0IzaaSJmaGLIbvRBD</span><span class="o">+</span><span class="vg">qatfUuQJB</span>
<span class="vg">MU</span><span class="o">/</span><span class="il">04</span><span class="vg">DdJIwvLtZBYdC2219m5dUBQaa4bimL</span><span class="o">+</span><span class="vg">YN9EcsDzD9h9UxQo5ReK7b3cNMzJ</span>
<span class="vg">BKJWLzFBcJuePMzAnLFktr</span><span class="o">/</span><span class="vg">RufX4wpXe6XJxoVPaHo72GorLkwnQ0HYMTY8rehT4</span>
<span class="vg">mDi1FI969LHCFFaFHSAaRnwdXaQkJmSfcxzCYQIDAQABAoIBAQCW3I4sKN5B9jOe</span>
<span class="vg">xq</span><span class="o">/</span><span class="vg">pkeWBq4OvhW8Ys1yW0zFT8t6nHbB1XrwscQygd8gE9BPqj3e0iIEqtdphbPmj</span>
<span class="vg">VHqTYbC0FI6QDClifV7noTwTBjeIOlgZ0NSUN0</span><span class="o">/</span><span class="vg">WgVzIOxUz2mZ2vBZUovKILPqG</span>
<span class="vg">TOi7J7RXMoySMdcXpP1f</span><span class="o">+</span><span class="vg">PgvYNcnKsT72UcWaSXEV8</span><span class="o">/</span><span class="vg">zo</span><span class="o">+</span><span class="vg">Zm</span><span class="o">/</span><span class="vg">qdGPVWwJonri5Mp</span>
<span class="vg">DVm5EQSENBiRyt028rU6ElXORNmoQpVjDVqZ1gipzXkifdjGyENw2rt4V</span><span class="o">/</span><span class="vg">iKYD7V</span>
<span class="nl">5</span><span class="vg">iqXOsvP6Cemf4gbrjunAgDG08S00kiUgvVWcdXW</span><span class="o">+</span><span class="vg">dlsR2nCvH4DOEe3AYYh</span><span class="o">/</span><span class="vg">aH8</span>
<span class="vg">DxEE7FbtAoGBAPcNO8fJ56mNw0ow4Qg38C</span><span class="o">+</span><span class="vg">Zss</span><span class="o">/</span><span class="vg">afhBOCfX4O</span><span class="o">/</span><span class="vg">SZKv</span><span class="o">/</span><span class="vg">roRn5</span><span class="o">+</span><span class="vg">gRM</span>
<span class="vg">KRJYSVXNnsjPI1plzqR4OCyOrjAhtuvL4a0DinDzf1</span><span class="o">+</span><span class="vg">fiztyNohwYsW1vYmqn3ti</span>
<span class="vg">EN0GhSgE7ppZjqvLQ3f3LUTxynhA0U</span><span class="o">+</span><span class="vg">k9wflb4irIlViTUlCsOPkrNJDAoGBANqL</span>
<span class="vg">Q</span><span class="o">+</span><span class="vg">vvuGSsmRLU</span><span class="o">/</span><span class="vg">Cenjy</span><span class="o">+</span><span class="vg">Mjj6</span><span class="o">+</span><span class="vg">QENg51dz34o8JKuVKIPKU8pNnyeLa5fat0qD2MHm</span>
<span class="vg">OB9opeQOcw0dStodxr6DB3wi83bpjeU6BWUGITNiWEaZEBrQ0aiqNJJKrrHm8fAZ</span>
<span class="nl">9</span><span class="vg">o4l4oHc4hI0kYVYYDuxtKuVJrzZiEapTwoOcYiLAoGBAI</span><span class="o">/</span><span class="vg">EWbeIHZIj9zOjgjEA</span>
<span class="vg">LHvm25HtulLOtyk2jd1njQhlHNk7CW2azIPqcLLH99EwCYi</span><span class="o">/</span><span class="vg">miNH</span><span class="o">+</span><span class="vg">pijZ2aHGCXb</span>
<span class="o">/</span><span class="vg">bZrSxM0ADmrZKDxdB6uGCyp</span><span class="o">+</span><span class="vg">GS2sBxjEyEsfCyvwhJ8b3Q100tqwiNO</span><span class="o">+</span><span class="vg">d5FCglp</span>
<span class="vg">HICx2dgUjuRVUliBwOK93nx1AoGAUI8RhIEjOYkeDAESyhNMBr0LGjnLOosX</span><span class="o">+/</span><span class="vg">as</span>
<span class="vg">qiotYkpjWuFULbibOFp</span><span class="o">+</span><span class="vg">WMW41vDvD9qrSXir3fstkeIAW5KqVkO6mJnRoT3Knnra</span>
<span class="vg">zjiKOITCAZQeiaP8BO5o3pxE9TMqb9VCO3ffnPstIoTaN4syPg7tiGo8k1SklVeH</span>
<span class="nl">2</span><span class="vg">S8lzq0CgYAKG2fljIYWQvGH628rp4ZcXS4hWmYohOxsnl1YrszbJ</span><span class="o">+</span><span class="vg">hzR</span><span class="o">+</span><span class="vg">IQOhGl</span>
<span class="vg">YlkUQYXhy9JixmUUKtH</span><span class="o">+</span><span class="vg">NXkKX7Lyc8XYw5ETr7JBT3ifs</span><span class="o">+</span><span class="vg">G7HruDjVG78EJVojbd</span>
<span class="nl">8</span><span class="vg">uLA</span><span class="o">+</span><span class="vg">DdQm5mg4vd1GTiSK65q</span><span class="o">/</span><span class="il">3</span><span class="vg">EeoBlUaVor3HhLFki</span><span class="o">+</span><span class="vg">i9qpT8CBsg</span><span class="o">==</span>
<span class="o">-----</span><span class="kr">END</span><span class="w"> </span><span class="vg">RSA</span><span class="w"> </span><span class="vg">PRIVATE</span><span class="w"> </span><span class="kr">KEY</span><span class="o">-----</span>
</pre></div>
<p>For this example, assume the following intent:</p>

<p>|key                 |value                   |
|--------------------|------------------------|
| Http Method        | POST                   |
| Path               | /organizations/clownco |
| Body               | Spec Body              |
| Timestamp          | 2009-01-01T12:00:00Z   |
| User               | spec-user              |
| Server Api Version | 1                      |
| Sign Protocol      | v1.3                   |</p>

<p>Using this information, we can generate the following message:</p>
<div class="highlight"><pre><span class="n">Method</span><span class="o">:</span><span class="n">POST</span>
<span class="n">Path</span><span class="o">:/</span><span class="n">organizations</span><span class="o">/</span><span class="n">clownco</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Content</span><span class="o">-</span><span class="n">Hash</span><span class="o">:</span><span class="n">hDlKNZhIhgso3Fs0S0pZwJ0xyBWtR1RBaeHs1DrzOho</span><span class="o">=</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Sign</span><span class="o">:</span><span class="n">version</span><span class="o">=</span><span class="mf">1.3</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Timestamp</span><span class="o">:</span><span class="mi">2009</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="n">T12</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="n">Z</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">UserId</span><span class="o">:</span><span class="n">spec</span><span class="o">-</span><span class="n">user</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Server</span><span class="o">-</span><span class="n">API</span><span class="o">-</span><span class="n">Version</span><span class="o">:</span><span class="mi">1</span>
</pre></div>
<p>Note the line endings are <code>\n</code>, and there is no newline character after <code>X-Ops-Server-API-Version:1</code>.</p>

<p>This message can now be signed, with the expected Base64 representation being:</p>
<div class="highlight"><pre><span class="vg">FZOmXAyOBAZQV</span><span class="o">/</span><span class="vg">uw188iBljBJXOm</span><span class="o">+</span><span class="vg">m8xQ</span><span class="o">/</span><span class="il">8</span><span class="vg">KTGLkgGwZNcRFxk1m953XjE3W</span>
<span class="vg">VGy1dFT76KeaNWmPCNtDmprfH2na5UZFtfLIKrPv7xm80V</span><span class="o">+</span><span class="vg">lzEzTd9WBwsfP</span>
<span class="nl">42</span><span class="vg">dZ9N</span><span class="o">+</span><span class="vg">V9I5SVfcL</span><span class="o">/</span><span class="vg">lWrrlpdybfceJC5jOcP5tzfJXWUITwb6Z3Erg3DU3Uh</span>
<span class="vg">H9h9E0qWlYGqmiNCVrBnpe6Si1gU</span><span class="o">/</span><span class="vg">Jl</span><span class="o">+</span><span class="vg">rXlRSNbLJ4GlArAPuL976iTYJTzE</span>
<span class="vg">MmbLUIm3JRYi00Yb01IUCCKdI90vUq1HHNtlTEu93YZfQaJwRxXlGkCNwIJe</span>
<span class="vg">fy49QzaCIEu1XiOx5Jn</span><span class="o">+</span><span class="il">4</span><span class="vg">GmkrZch</span><span class="o">/</span><span class="vg">RrK9VzQWXgs</span><span class="o">+</span><span class="vg">w</span><span class="o">==</span>
</pre></div>
<p>The Chef server should expect the following headers to be passed along:</p>

<p>| name                  | value                                                        |
|-----------------------|--------------------------------------------------------------|
| X-Ops-Authorization-1 | FZOmXAyOBAZQV/uw188iBljBJXOm+m8xQ/8KTGLkgGwZNcRFxk1m953XjE3W |
| X-Ops-Authorization-2 | VGy1dFT76KeaNWmPCNtDmprfH2na5UZFtfLIKrPv7xm80V+lzEzTd9WBwsfP |
| X-Ops-Authorization-3 | 42dZ9N+V9I5SVfcL/lWrrlpdybfceJC5jOcP5tzfJXWUITwb6Z3Erg3DU3Uh |
| X-Ops-Authorization-4 | H9h9E0qWlYGqmiNCVrBnpe6Si1gU/Jl+rXlRSNbLJ4GlArAPuL976iTYJTzE |
| X-Ops-Authorization-5 | MmbLUIm3JRYi00Yb01IUCCKdI90vUq1HHNtlTEu93YZfQaJwRxXlGkCNwIJe |
| X-Ops-Authorization-6 | fy49QzaCIEu1XiOx5Jn+4GmkrZch/RrK9VzQWXgs+w==                 |</p>

<h2>Compatibility</h2>

<p>The Chef server currently returns the supported protocol versions when failing to authenticate. This information is returned in the <code>WWW-Authenticate</code> header of the response along with a response code of <code>401</code>. An example of a value that is returned that header is <code>X-Ops-Sign version=&quot;1.0&quot; version=&quot;1.1&quot;</code>, with a  response body of <code>{&quot;error&quot;:[&quot;Invalid signature for user or client &#39;foo&#39;&quot;]}</code>. The response provides no information as to why the authentication failed.</p>

<h2>Copyright</h2>

<p>This work is in the public domain. In jurisdictions that do not allow for this, this work is available under CC0. To the extent possible under law, the person who associated CC0 with this work has waived all copyright and related or neighboring rights to this work.</p>
    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  </body>
</html>
