<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <title>Chef RFCs</title>
    <link href='//fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href="/images/favicon.ico" rel="shortcut icon">
    <script src="//style.chef.io/dist/0.1.8/javascripts/vendor/modernizr.js"></script>
    <link rel="stylesheet" href="//style.chef.io/dist/1.0.1/stylesheets/chef.css">
  </head>
  <body>
    <div class="container">
      <header class="clearfix">
        <div class="left">
          <a href="http://chef.github.io"><h1>Chef RFCs</h1></a>
        </div>
      </header>
<h1>Let users trigger another resource prior to an action happening.</h1>

<h2>Motivation</h2>
<div class="highlight"><pre><span class="vg">As</span><span class="w"> </span><span class="vg">a</span><span class="w"> </span><span class="vg">Chef</span><span class="w"> </span><span class="vg">user</span><span class="p">,</span>
<span class="vg">I</span><span class="w"> </span><span class="vg">want</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="vg">make</span><span class="w"> </span><span class="vg">one</span><span class="w"> </span><span class="vg">resource</span><span class="w"> </span><span class="vg">action</span><span class="w"> </span><span class="vg">a</span><span class="w"> </span><span class="vg">precondition</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">another</span><span class="p">,</span>
<span class="vg">So</span><span class="w"> </span><span class="vg">that</span><span class="w"> </span><span class="vg">when</span><span class="w"> </span><span class="vg">two</span><span class="w"> </span><span class="vg">resources</span><span class="w"> </span><span class="vg">depend</span><span class="w"> </span><span class="vg">on</span><span class="w"> </span><span class="vg">each</span><span class="w"> </span><span class="vg">other</span><span class="p">,</span><span class="w"> </span><span class="vg">I</span><span class="w"> </span><span class="vg">can</span><span class="w"> </span><span class="vg">make</span><span class="w"> </span><span class="vg">an</span><span class="w"> </span><span class="vg">update</span><span class="w"> </span><span class="vg">succeed</span><span class="o">.</span>

<span class="vg">As</span><span class="w"> </span><span class="vg">a</span><span class="w"> </span><span class="vg">Chef</span><span class="w"> </span><span class="vg">user</span><span class="p">,</span>
<span class="vg">I</span><span class="w"> </span><span class="vg">want</span><span class="w"> </span><span class="vg">this</span><span class="w"> </span><span class="vg">action</span><span class="w"> </span><span class="vg">only</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="vg">happen</span><span class="w"> </span><span class="vg">if</span><span class="w"> </span><span class="vg">the</span><span class="w"> </span><span class="vg">other</span><span class="w"> </span><span class="vg">resource</span><span class="w"> </span><span class="o">*</span><span class="vg">does</span><span class="o">*</span><span class="w"> </span><span class="vg">update</span><span class="p">,</span>
<span class="vg">So</span><span class="w"> </span><span class="vg">that</span><span class="w"> </span><span class="vg">I</span><span class="w"> </span><span class="vg">don</span><span class="c1">&#39;t unnecessarily run my preconditions on every single Chef run.</span>

<span class="vg">As</span><span class="w"> </span><span class="vg">a</span><span class="w"> </span><span class="vg">Chef</span><span class="w"> </span><span class="vg">user</span><span class="p">,</span>
<span class="vg">I</span><span class="w"> </span><span class="vg">want</span><span class="w"> </span><span class="vg">Chef</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="vg">run</span><span class="w"> </span><span class="vg">me</span><span class="w"> </span><span class="vg">an</span><span class="w"> </span><span class="vg">action</span><span class="w"> </span><span class="vg">if</span><span class="w"> </span><span class="vg">a</span><span class="w"> </span><span class="vg">resource</span><span class="w"> </span><span class="vg">updates</span><span class="p">,</span>
<span class="vg">So</span><span class="w"> </span><span class="vg">that</span><span class="w"> </span><span class="vg">I</span><span class="w"> </span><span class="vg">don</span><span class="c1">&#39;t have to implement the resource test logic in my recipe.</span>
</pre></div>
<h2>Specification</h2>

<p>We add a new :before timing which causes a notification to happen
<em>before</em> the resource actually updates. If the resource will not actually update,
this event does not fire.</p>

<p>The events you can specify would become:</p>

<ul>
<li>:before - before the resource updates, but <em>only</em> if an update will occur.</li>
<li>:immediately - after the resource updates, but <em>only</em> if an update occurred.</li>
<li>:delayed - after the resource updates, at the end of the run.</li>
</ul>
<div class="highlight"><pre><span class="n">package</span> <span class="s2">&quot;foo&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:upgrade</span>
  <span class="c1"># The package upgrade will fail if we try to upgrade while it runs!!!</span>
  <span class="n">notifies</span> <span class="ss">:stop</span><span class="p">,</span> <span class="s2">&quot;service[blah]&quot;</span><span class="p">,</span> <span class="ss">:before</span>
<span class="k">end</span>

<span class="n">service</span> <span class="s2">&quot;blah&quot;</span> <span class="k">do</span>
<span class="k">end</span>
</pre></div>
<p>This will work for both subscribes and notifies.</p>

<h3>Backwards Compatibility</h3>

<p>This will only affect resources which have :before on them, and will
not modify any existing resources or recipes.</p>

<h3>Implementation</h3>

<p>There is a tricky implementation detail here, because both the test (&quot;is my
package version lower than the latest?&quot;) and the set (&quot;call rpm and update the
package&quot;) part of a resource are both part of the action. Chef only runs one
action to run at a time, and it seems ill-advised to change that without a lot
of extra thinking.</p>

<p>To get around this without breaking the model, we propose that resources with an
<code>:before</code> action run a why-run test of the action and trigger off of
that, before running the action for real. The flow of this resource:</p>
<div class="highlight"><pre><span class="n">package</span> <span class="s2">&quot;foo&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:upgrade</span>
  <span class="n">notifies</span> <span class="ss">:stop</span><span class="p">,</span> <span class="s2">&quot;service[blah]&quot;</span><span class="p">,</span> <span class="ss">:before</span>
<span class="k">end</span>
</pre></div>
<p>The execution of the package upgrade looks like this:</p>

<ol>
<li>If :before events are on the resource:
a. raise an error if the resource does not support why-run.
b. Turn on why-run temporarily.
c. Run the action.
d. Send the notification if updated<em>by</em>last_action? is true.
e. Turn off why-run.</li>
<li>Run the action (for real!).</li>
<li>Send :immediate or :delayed notifications if updated<em>by</em>last_action? is true.</li>
</ol>

<h2>Copyright</h2>

<p>This work is in the public domain. In jurisdictions that do not allow for this,
this work is available under CC0. To the extent possible under law, the person
who associated CC0 with this work has waived all copyright and related or
neighboring rights to this work.</p>
    </div>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.3/fastclick.min.js"></script>
    <script src="//style.chef.io/dist/1.0.1/javascripts/chef.js"></script>
    <script>
      $(document).chef({
        assets: {
          images: '//style.chef.io/assets/images'
        }
      });
    </script>
  </body>
</html>
