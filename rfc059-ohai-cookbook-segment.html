<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation-essential/6.2.2/css/foundation.min.css">
    <style>
      a { color: #f18b21; }
      a:hover, a:focus { color: #3f5364; }
    </style>
    <title>Chef RFCs</title>
  </head>
  <body>
    <div class="row medium-12 columns">
      <header class="clearfix">
        <div class="left">
          <a href="/chef-rfc"><h1>Chef RFCs</h1></a>
        </div>
      </header>
<h1>Add Ohai cookbook segment</h1>

<p>Support Ohai plugins under an <code>ohai</code> top level directory in cookbooks.  Load all
Ohai plugins in all synchronized cookbooks after cookbook synchronization.</p>

<h2>Motivation</h2>
<div class="highlight"><pre><span class="vg">As</span><span class="w"> </span><span class="vg">a</span><span class="w"> </span><span class="vg">Chef</span><span class="w"> </span><span class="vg">User</span><span class="p">,</span>
<span class="vg">I</span><span class="w"> </span><span class="vg">want</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="vg">have</span><span class="w"> </span><span class="vg">my</span><span class="w"> </span><span class="vg">custom</span><span class="w"> </span><span class="vg">Ohai</span><span class="w"> </span><span class="vg">plugins</span><span class="w"> </span><span class="vg">loaded</span><span class="w"> </span><span class="vg">on</span><span class="w"> </span><span class="vg">first</span><span class="w"> </span><span class="vg">bootstrap</span><span class="p">,</span>
<span class="vg">So</span><span class="w"> </span><span class="vg">I</span><span class="w"> </span><span class="vg">don</span><span class="c1">&#39;t have to run chef twice.</span>

<span class="vg">As</span><span class="w"> </span><span class="vg">a</span><span class="w"> </span><span class="vg">Chef</span><span class="w"> </span><span class="vg">User</span><span class="p">,</span>
<span class="vg">I</span><span class="w"> </span><span class="vg">want</span><span class="w"> </span><span class="vg">my</span><span class="w"> </span><span class="vg">Ohai</span><span class="w"> </span><span class="vg">plugins</span><span class="w"> </span><span class="vg">loaded</span><span class="w"> </span><span class="vg">before</span><span class="w"> </span><span class="vg">attributes</span><span class="w"> </span><span class="vg">and</span><span class="w"> </span><span class="vg">compile</span><span class="o">/</span><span class="vg">converge</span><span class="w"> </span><span class="vg">mode</span><span class="p">,</span>
<span class="vg">So</span><span class="w"> </span><span class="vg">I</span><span class="w"> </span><span class="vg">can</span><span class="w"> </span><span class="vg">use</span><span class="w"> </span><span class="vg">them</span><span class="w"> </span><span class="vg">without</span><span class="w"> </span><span class="vg">worrying</span><span class="w"> </span><span class="vg">about</span><span class="w"> </span><span class="vg">cookbook</span><span class="w"> </span><span class="vg">execution</span><span class="w"> </span><span class="vg">ordering</span><span class="o">.</span>

<span class="vg">As</span><span class="w"> </span><span class="vg">a</span><span class="w"> </span><span class="vg">Chef</span><span class="w"> </span><span class="vg">User</span><span class="p">,</span>
<span class="vg">I</span><span class="w"> </span><span class="vg">want</span><span class="w"> </span><span class="vg">my</span><span class="w"> </span><span class="vg">Ohai</span><span class="w"> </span><span class="vg">plugins</span><span class="w"> </span><span class="vg">synchronized</span><span class="w"> </span><span class="vg">with</span><span class="w"> </span><span class="vg">my</span><span class="w"> </span><span class="vg">cookbooks</span><span class="p">,</span>
<span class="vg">So</span><span class="w"> </span><span class="vg">that</span><span class="w"> </span><span class="vg">I</span><span class="w"> </span><span class="vg">don</span><span class="c1">&#39;t incure more unavoidable round-trips to the Chef Server.</span>

<span class="vg">As</span><span class="w"> </span><span class="vg">a</span><span class="w"> </span><span class="vg">Chef</span><span class="w"> </span><span class="vg">Developer</span><span class="p">,</span>
<span class="vg">I</span><span class="w"> </span><span class="vg">want</span><span class="w"> </span><span class="vg">Ohai</span><span class="w"> </span><span class="vg">plugins</span><span class="w"> </span><span class="vg">as</span><span class="w"> </span><span class="vg">a</span><span class="w"> </span><span class="vg">first</span><span class="o">-</span><span class="vg">class</span><span class="w"> </span><span class="vg">object</span><span class="p">,</span>
<span class="vg">So</span><span class="w"> </span><span class="vg">that</span><span class="w"> </span><span class="vg">I</span><span class="w"> </span><span class="vg">don</span><span class="c1">&#39;t have to compile recipes to discover templates that drop plugins.</span>
</pre></div>
<h2>Specification</h2>

<p>The &quot;segments&quot; of a cookbook will be extended to include an &quot;ohai&quot; segment.  In this segment there will be plugins which are intended to be copied to the Ohai <code>plugin_path</code>.  All files in this segment will be copied, recursively, maintaining directory structure.</p>

<p>In the <code>Chef::RunContext::CookbookCompiler#compile</code> method a phase will be added after <code>compile_libraries</code> and before <code>compile_attributes</code> which will copy the Ohai plugins from the cookbook segment and will load all of the discovered plugins.</p>

<p>The plugins will be copied from <code>&lt;cookbookname&gt;/ohai</code> into <code>/etc/chef/ohai/cookbook-plugins/&lt;cookbookname&gt;</code> as their top level directory (recursively).  The state of the entire
subdirectory tree under <code>/etc/chef/ohai/cookbook-plugins</code> will be managed fully by chef-client so that any files which are not synchronized by chef-client will be removed, so
that removal of a plugin from a cookbook or removal of the cookbook from <code>run_list</code> will result in the plugin being removed on the target host.</p>

<p>The plugins directory will work similarly to libraries and other directions in that there will be no control over the inclusion of plugins below the level of the inclusion of the cookbook itself in the <code>run_list</code>.</p>

<p>When plugins override other plugins on loading, and in particular when cookbook plugins override core plugins, they should WARN the user.  This will address the case where a user has included a custom plugin and Ohai is later extended with similar functionality in the same namespace.  The custom plugin should take precedence for backwards compatibility.  There should be a way to silence the warning with a DSL method added to the custom plugin.</p>

<h2>Copyright</h2>

<p>This work is in the public domain. In jurisdictions that do not allow for this,
this work is available under CC0. To the extent possible under law, the person
who associated CC0 with this work has waived all copyright and related or
neighboring rights to this work.</p>
    </div>
  </body>
</html>
